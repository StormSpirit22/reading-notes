# 16 å†…å­˜åˆ†é…

ç”±äºç›®å‰ç‰ˆæœ¬ (go version go1.17 darwin/amd64) çš„ Go å†…å­˜éƒ¨åˆ†æºç ä¸ä¹¦ä¸­ç›¸å·®æ¯”è¾ƒå¤§ï¼Œæ‰€ä»¥è¿™ä¸€ç« ä¼šå¼•ç”¨ [å†…å­˜åˆ†é…å™¨ ](https://draveness.me/golang/docs/part3-runtime/ch07-memory/golang-memory-allocator/)è¿™ç¯‡æ–‡ç« ï¼Œå†ç»“åˆä¹¦ç±åšä¸€ä¸‹è¡¥å……ã€‚

ä»¥ä¸‹å†…å®¹æ¥è‡ª [å†…å­˜åˆ†é…å™¨ ](https://draveness.me/golang/docs/part3-runtime/ch07-memory/golang-memory-allocator/#71-å†…å­˜åˆ†é…å™¨)- Draveness

ç¨‹åºä¸­çš„æ•°æ®å’Œå˜é‡éƒ½ä¼šè¢«åˆ†é…åˆ°ç¨‹åºæ‰€åœ¨çš„è™šæ‹Ÿå†…å­˜ä¸­ï¼Œå†…å­˜ç©ºé—´åŒ…å«ä¸¤ä¸ªé‡è¦åŒºåŸŸï¼šæ ˆåŒºï¼ˆStackï¼‰å’Œå †åŒºï¼ˆHeapï¼‰ã€‚**å‡½æ•°è°ƒç”¨çš„å‚æ•°ã€è¿”å›å€¼ä»¥åŠå±€éƒ¨å˜é‡å¤§éƒ½ä¼šè¢«åˆ†é…åˆ°æ ˆä¸Š**ï¼Œè¿™éƒ¨åˆ†å†…å­˜ä¼šç”±ç¼–è¯‘å™¨è¿›è¡Œç®¡ç†ï¼›ä¸åŒç¼–ç¨‹è¯­è¨€ä½¿ç”¨ä¸åŒçš„æ–¹æ³•ç®¡ç†å †åŒºçš„å†…å­˜ï¼ŒC++ ç­‰ç¼–ç¨‹è¯­è¨€ä¼šç”±å·¥ç¨‹å¸ˆä¸»åŠ¨ç”³è¯·å’Œé‡Šæ”¾å†…å­˜ï¼ŒGo ä»¥åŠ Java ç­‰ç¼–ç¨‹è¯­è¨€ä¼šç”±å·¥ç¨‹å¸ˆå’Œç¼–è¯‘å™¨å…±åŒç®¡ç†ï¼Œ**å †ä¸­çš„å¯¹è±¡ç”±å†…å­˜åˆ†é…å™¨åˆ†é…å¹¶ç”±åƒåœ¾æ”¶é›†å™¨å›æ”¶ã€‚**



## è®¾è®¡åŸç†

å†…å­˜ç®¡ç†ä¸€èˆ¬åŒ…å«ä¸‰ä¸ªä¸åŒçš„ç»„ä»¶ï¼Œåˆ†åˆ«æ˜¯ç”¨æˆ·ç¨‹åºï¼ˆMutatorï¼‰ã€åˆ†é…å™¨ï¼ˆAllocatorï¼‰å’Œæ”¶é›†å™¨ï¼ˆCollectorï¼‰[1](https://draveness.me/golang/docs/part3-runtime/ch07-memory/golang-memory-allocator/#fn:1)ï¼Œå½“ç”¨æˆ·ç¨‹åºç”³è¯·å†…å­˜æ—¶ï¼Œå®ƒä¼šé€šè¿‡å†…å­˜åˆ†é…å™¨ç”³è¯·æ–°å†…å­˜ï¼Œè€Œåˆ†é…å™¨ä¼šè´Ÿè´£ä»å †ä¸­åˆå§‹åŒ–ç›¸åº”çš„å†…å­˜åŒºåŸŸã€‚

![mutator-allocator-collector](https://img.draveness.me/2020-02-29-15829868066411-mutator-allocator-collector.png)



### åˆ†é…æ–¹æ³•

ç¼–ç¨‹è¯­è¨€çš„å†…å­˜åˆ†é…å™¨ä¸€èˆ¬åŒ…å«ä¸¤ç§åˆ†é…æ–¹æ³•ï¼Œä¸€ç§æ˜¯çº¿æ€§åˆ†é…å™¨ï¼ˆSequential Allocatorï¼ŒBump Allocatorï¼‰ï¼Œå¦ä¸€ç§æ˜¯ç©ºé—²é“¾è¡¨åˆ†é…å™¨ï¼ˆFree-List Allocatorï¼‰ã€‚

#### çº¿æ€§åˆ†é…å™¨

çº¿æ€§åˆ†é…ï¼ˆBump Allocatorï¼‰æ˜¯ä¸€ç§é«˜æ•ˆçš„å†…å­˜åˆ†é…æ–¹æ³•ï¼Œä½†æ˜¯æœ‰è¾ƒå¤§çš„å±€é™æ€§ã€‚å½“æˆ‘ä»¬ä½¿ç”¨çº¿æ€§åˆ†é…å™¨æ—¶ï¼Œåªéœ€è¦åœ¨å†…å­˜ä¸­ç»´æŠ¤ä¸€ä¸ªæŒ‡å‘å†…å­˜ç‰¹å®šä½ç½®çš„æŒ‡é’ˆï¼Œå¦‚æœç”¨æˆ·ç¨‹åºå‘åˆ†é…å™¨ç”³è¯·å†…å­˜ï¼Œåˆ†é…å™¨åªéœ€è¦æ£€æŸ¥å‰©ä½™çš„ç©ºé—²å†…å­˜ã€è¿”å›åˆ†é…çš„å†…å­˜åŒºåŸŸå¹¶ä¿®æ”¹æŒ‡é’ˆåœ¨å†…å­˜ä¸­çš„ä½ç½®ï¼Œå³ç§»åŠ¨ä¸‹å›¾ä¸­çš„æŒ‡é’ˆï¼š

![bump-allocator](https://img.draveness.me/2020-02-29-15829868066435-bump-allocator.png)



è™½ç„¶çº¿æ€§åˆ†é…å™¨å®ç°ä¸ºå®ƒå¸¦æ¥äº†è¾ƒå¿«çš„æ‰§è¡Œé€Ÿåº¦ä»¥åŠè¾ƒä½çš„å®ç°å¤æ‚åº¦ï¼Œä½†æ˜¯çº¿æ€§åˆ†é…å™¨æ— æ³•åœ¨å†…å­˜è¢«é‡Šæ”¾æ—¶é‡ç”¨å†…å­˜ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå¦‚æœå·²ç»åˆ†é…çš„å†…å­˜è¢«å›æ”¶ï¼Œçº¿æ€§åˆ†é…å™¨æ— æ³•é‡æ–°åˆ©ç”¨çº¢è‰²çš„å†…å­˜ï¼š

![bump-allocator-reclaim-memory](https://img.draveness.me/2020-02-29-15829868066441-bump-allocator-reclaim-memory.png)

å› ä¸ºçº¿æ€§åˆ†é…å™¨å…·æœ‰ä¸Šè¿°ç‰¹æ€§ï¼Œæ‰€ä»¥éœ€è¦ä¸åˆé€‚çš„åƒåœ¾å›æ”¶ç®—æ³•é…åˆä½¿ç”¨ï¼Œä¾‹å¦‚ï¼šæ ‡è®°å‹ç¼©ï¼ˆMark-Compactï¼‰ã€å¤åˆ¶å›æ”¶ï¼ˆCopying GCï¼‰å’Œåˆ†ä»£å›æ”¶ï¼ˆGenerational GCï¼‰ç­‰ç®—æ³•ï¼Œå®ƒä»¬å¯ä»¥é€šè¿‡æ‹·è´çš„æ–¹å¼æ•´ç†å­˜æ´»å¯¹è±¡çš„ç¢ç‰‡ï¼Œå°†ç©ºé—²å†…å­˜å®šæœŸåˆå¹¶ï¼Œè¿™æ ·å°±èƒ½åˆ©ç”¨çº¿æ€§åˆ†é…å™¨çš„æ•ˆç‡æå‡å†…å­˜åˆ†é…å™¨çš„æ€§èƒ½äº†ã€‚

#### ç©ºé—²é“¾è¡¨åˆ†é…å™¨ [#](https://draveness.me/golang/docs/part3-runtime/ch07-memory/golang-memory-allocator/#ç©ºé—²é“¾è¡¨åˆ†é…å™¨)

ç©ºé—²é“¾è¡¨åˆ†é…å™¨ï¼ˆFree-List Allocatorï¼‰å¯ä»¥é‡ç”¨å·²ç»è¢«é‡Šæ”¾çš„å†…å­˜ï¼Œå®ƒåœ¨å†…éƒ¨ä¼šç»´æŠ¤ä¸€ä¸ªç±»ä¼¼é“¾è¡¨çš„æ•°æ®ç»“æ„ã€‚å½“ç”¨æˆ·ç¨‹åºç”³è¯·å†…å­˜æ—¶ï¼Œç©ºé—²é“¾è¡¨åˆ†é…å™¨ä¼šä¾æ¬¡éå†ç©ºé—²çš„å†…å­˜å—ï¼Œæ‰¾åˆ°è¶³å¤Ÿå¤§çš„å†…å­˜ï¼Œç„¶åç”³è¯·æ–°çš„èµ„æºå¹¶ä¿®æ”¹é“¾è¡¨ï¼š

![free-list-allocator](https://img.draveness.me/2020-02-29-15829868066446-free-list-allocator.png)

å› ä¸ºä¸åŒçš„å†…å­˜å—é€šè¿‡æŒ‡é’ˆæ„æˆäº†é“¾è¡¨ï¼Œæ‰€ä»¥ä½¿ç”¨è¿™ç§æ–¹å¼çš„åˆ†é…å™¨å¯ä»¥é‡æ–°åˆ©ç”¨å›æ”¶çš„èµ„æºï¼Œä½†æ˜¯å› ä¸ºåˆ†é…å†…å­˜æ—¶éœ€è¦éå†é“¾è¡¨ï¼Œæ‰€ä»¥å®ƒçš„æ—¶é—´å¤æ‚åº¦æ˜¯ ğ‘‚(ğ‘›)O(n)ã€‚ç©ºé—²é“¾è¡¨åˆ†é…å™¨å¯ä»¥é€‰æ‹©ä¸åŒçš„ç­–ç•¥åœ¨é“¾è¡¨ä¸­çš„å†…å­˜å—ä¸­è¿›è¡Œé€‰æ‹©ï¼Œæœ€å¸¸è§çš„æ˜¯ä»¥ä¸‹å››ç§ï¼š

- é¦–æ¬¡é€‚åº”ï¼ˆFirst-Fitï¼‰â€” ä»é“¾è¡¨å¤´å¼€å§‹éå†ï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ªå¤§å°å¤§äºç”³è¯·å†…å­˜çš„å†…å­˜å—ï¼›
- å¾ªç¯é¦–æ¬¡é€‚åº”ï¼ˆNext-Fitï¼‰â€” ä»ä¸Šæ¬¡éå†çš„ç»“æŸä½ç½®å¼€å§‹éå†ï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ªå¤§å°å¤§äºç”³è¯·å†…å­˜çš„å†…å­˜å—ï¼›
- æœ€ä¼˜é€‚åº”ï¼ˆBest-Fitï¼‰â€” ä»é“¾è¡¨å¤´éå†æ•´ä¸ªé“¾è¡¨ï¼Œé€‰æ‹©æœ€åˆé€‚çš„å†…å­˜å—ï¼›
- éš”ç¦»é€‚åº”ï¼ˆSegregated-Fitï¼‰â€” å°†å†…å­˜åˆ†å‰²æˆå¤šä¸ªé“¾è¡¨ï¼Œæ¯ä¸ªé“¾è¡¨ä¸­çš„å†…å­˜å—å¤§å°ç›¸åŒï¼Œç”³è¯·å†…å­˜æ—¶å…ˆæ‰¾åˆ°æ»¡è¶³æ¡ä»¶çš„é“¾è¡¨ï¼Œå†ä»é“¾è¡¨ä¸­é€‰æ‹©åˆé€‚çš„å†…å­˜å—ï¼›

ä¸Šè¿°å››ç§ç­–ç•¥çš„å‰ä¸‰ç§å°±ä¸è¿‡å¤šä»‹ç»äº†ï¼ŒGo è¯­è¨€ä½¿ç”¨çš„å†…å­˜åˆ†é…ç­–ç•¥ä¸ç¬¬å››ç§ç­–ç•¥æœ‰äº›ç›¸ä¼¼ï¼Œæˆ‘ä»¬é€šè¿‡ä¸‹å›¾äº†è§£è¯¥ç­–ç•¥çš„åŸç†ï¼š

![segregated-list](https://img.draveness.me/2020-02-29-15829868066452-segregated-list.png)

å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œè¯¥ç­–ç•¥ä¼šå°†å†…å­˜åˆ†å‰²æˆç”± 4ã€8ã€16ã€32 å­—èŠ‚çš„å†…å­˜å—ç»„æˆçš„é“¾è¡¨ï¼Œå½“æˆ‘ä»¬å‘å†…å­˜åˆ†é…å™¨ç”³è¯· 8 å­—èŠ‚çš„å†…å­˜æ—¶ï¼Œå®ƒä¼šåœ¨ä¸Šå›¾ä¸­æ‰¾åˆ°æ»¡è¶³æ¡ä»¶çš„ç©ºé—²å†…å­˜å—å¹¶è¿”å›ã€‚éš”ç¦»é€‚åº”çš„åˆ†é…ç­–ç•¥å‡å°‘äº†éœ€è¦éå†çš„å†…å­˜å—æ•°é‡ï¼Œæé«˜äº†å†…å­˜åˆ†é…çš„æ•ˆç‡ã€‚

#### åˆ†çº§åˆ†é… 

çº¿ç¨‹ç¼“å­˜åˆ†é…ï¼ˆThread-Caching Mallocï¼ŒTCMallocï¼‰æ˜¯ç”¨äºåˆ†é…å†…å­˜çš„æœºåˆ¶ï¼Œå®ƒæ¯” glibc ä¸­çš„ `malloc` è¿˜è¦å¿«å¾ˆå¤š[2](https://draveness.me/golang/docs/part3-runtime/ch07-memory/golang-memory-allocator/#fn:2)ã€‚Go è¯­è¨€çš„å†…å­˜åˆ†é…å™¨å°±å€Ÿé‰´äº† TCMalloc çš„è®¾è®¡å®ç°é«˜é€Ÿçš„å†…å­˜åˆ†é…ï¼Œå®ƒçš„æ ¸å¿ƒç†å¿µæ˜¯ä½¿ç”¨**å¤šçº§ç¼“å­˜å°†å¯¹è±¡æ ¹æ®å¤§å°åˆ†ç±»**ï¼Œå¹¶æŒ‰ç…§ç±»åˆ«å®æ–½ä¸åŒçš„åˆ†é…ç­–ç•¥ã€‚

#### å¯¹è±¡å¤§å° [#](https://draveness.me/golang/docs/part3-runtime/ch07-memory/golang-memory-allocator/#å¯¹è±¡å¤§å°)

Go è¯­è¨€çš„å†…å­˜åˆ†é…å™¨ä¼šæ ¹æ®ç”³è¯·åˆ†é…çš„å†…å­˜å¤§å°é€‰æ‹©ä¸åŒçš„å¤„ç†é€»è¾‘ï¼Œè¿è¡Œæ—¶æ ¹æ®å¯¹è±¡çš„å¤§å°å°†å¯¹è±¡åˆ†æˆå¾®å¯¹è±¡ã€å°å¯¹è±¡å’Œå¤§å¯¹è±¡ä¸‰ç§ï¼š

|  ç±»åˆ«  |     å¤§å°      |
| :----: | :-----------: |
| å¾®å¯¹è±¡ |  `(0, 16B)`   |
| å°å¯¹è±¡ | `[16B, 32KB]` |
| å¤§å¯¹è±¡ | `(32KB, +âˆ)`  |

#### å¤šçº§ç¼“å­˜ [#](https://draveness.me/golang/docs/part3-runtime/ch07-memory/golang-memory-allocator/#å¤šçº§ç¼“å­˜)

å†…å­˜åˆ†é…å™¨ä¸ä»…ä¼šåŒºåˆ«å¯¹å¾…å¤§å°ä¸åŒçš„å¯¹è±¡ï¼Œè¿˜ä¼šå°†å†…å­˜åˆ†æˆä¸åŒçš„çº§åˆ«åˆ†åˆ«ç®¡ç†ï¼ŒTCMalloc å’Œ Go è¿è¡Œæ—¶åˆ†é…å™¨éƒ½ä¼šå¼•å…¥çº¿ç¨‹ç¼“å­˜ï¼ˆThread Cacheï¼‰ã€ä¸­å¿ƒç¼“å­˜ï¼ˆCentral Cacheï¼‰å’Œé¡µå †ï¼ˆPage Heapï¼‰ä¸‰ä¸ªç»„ä»¶åˆ†çº§ç®¡ç†å†…å­˜ï¼ˆå…¶å®å°±æ˜¯åé¢çš„ cacheã€central å’Œ heapï¼‰ï¼š

![multi-level-cache](https://img.draveness.me/2020-02-29-15829868066457-multi-level-cache.png)

çº¿ç¨‹ç¼“å­˜å±äºæ¯ä¸€ä¸ªç‹¬ç«‹çš„çº¿ç¨‹ï¼Œå®ƒèƒ½å¤Ÿæ»¡è¶³çº¿ç¨‹ä¸Šç»å¤§å¤šæ•°çš„å†…å­˜åˆ†é…éœ€æ±‚ï¼Œå› ä¸ºä¸æ¶‰åŠå¤šçº¿ç¨‹ï¼Œæ‰€ä»¥ä¹Ÿä¸éœ€è¦ä½¿ç”¨äº’æ–¥é”æ¥ä¿æŠ¤å†…å­˜ï¼Œè¿™èƒ½å¤Ÿå‡å°‘é”ç«äº‰å¸¦æ¥çš„æ€§èƒ½æŸè€—ã€‚å½“çº¿ç¨‹ç¼“å­˜ä¸èƒ½æ»¡è¶³éœ€æ±‚æ—¶ï¼Œè¿è¡Œæ—¶ä¼šä½¿ç”¨ä¸­å¿ƒç¼“å­˜ä½œä¸ºè¡¥å……è§£å†³å°å¯¹è±¡çš„å†…å­˜åˆ†é…ï¼Œåœ¨é‡åˆ° 32KB ä»¥ä¸Šçš„å¯¹è±¡æ—¶ï¼Œå†…å­˜åˆ†é…å™¨ä¼šé€‰æ‹©é¡µå †ç›´æ¥åˆ†é…å¤§å†…å­˜ã€‚

### è™šæ‹Ÿå†…å­˜å¸ƒå±€ [#](https://draveness.me/golang/docs/part3-runtime/ch07-memory/golang-memory-allocator/#è™šæ‹Ÿå†…å­˜å¸ƒå±€)

è¿™é‡Œä¼šä»‹ç» Go è¯­è¨€å †åŒºå†…å­˜åœ°å€ç©ºé—´çš„è®¾è®¡ä»¥åŠæ¼”è¿›è¿‡ç¨‹ï¼Œåœ¨ Go è¯­è¨€ 1.10 ä»¥å‰çš„ç‰ˆæœ¬ï¼Œå †åŒºçš„å†…å­˜ç©ºé—´éƒ½æ˜¯è¿ç»­çš„ï¼›ä½†æ˜¯åœ¨ 1.11 ç‰ˆæœ¬ï¼ŒGo å›¢é˜Ÿä½¿ç”¨ç¨€ç–çš„å †å†…å­˜ç©ºé—´æ›¿ä»£äº†è¿ç»­çš„å†…å­˜ï¼Œè§£å†³äº†è¿ç»­å†…å­˜å¸¦æ¥çš„é™åˆ¶ä»¥åŠåœ¨ç‰¹æ®Šåœºæ™¯ä¸‹å¯èƒ½å‡ºç°çš„é—®é¢˜ã€‚

#### çº¿æ€§å†…å­˜ [#](https://draveness.me/golang/docs/part3-runtime/ch07-memory/golang-memory-allocator/#çº¿æ€§å†…å­˜)

Go è¯­è¨€ç¨‹åºçš„ 1.10 ç‰ˆæœ¬åœ¨å¯åŠ¨æ—¶ä¼šåˆå§‹åŒ–æ•´ç‰‡è™šæ‹Ÿå†…å­˜åŒºåŸŸï¼Œå¦‚ä¸‹æ‰€ç¤ºçš„ä¸‰ä¸ªåŒºåŸŸ `spans`ã€`bitmap` å’Œ `arena` åˆ†åˆ«é¢„ç•™äº† 512MBã€16GB ä»¥åŠ 512GB çš„å†…å­˜ç©ºé—´ï¼Œè¿™äº›å†…å­˜å¹¶ä¸æ˜¯çœŸæ­£å­˜åœ¨çš„ç‰©ç†å†…å­˜ï¼Œè€Œæ˜¯è™šæ‹Ÿå†…å­˜ï¼š 

![heap-before-go-1-10](https://img.draveness.me/2020-10-19-16031147347484/heap-before-go-1-10.png)

- `spans` åŒºåŸŸå­˜å‚¨äº†æŒ‡å‘å†…å­˜ç®¡ç†å•å…ƒ [`runtime.mspan`](https://draveness.me/golang/tree/runtime.mspan) çš„æŒ‡é’ˆï¼Œæ¯ä¸ªå†…å­˜å•å…ƒä¼šç®¡ç†å‡ é¡µçš„å†…å­˜ç©ºé—´ï¼Œæ¯é¡µå¤§å°ä¸º 8KBï¼›
- `bitmap` ç”¨äºæ ‡è¯† `arena` åŒºåŸŸä¸­çš„å“ªäº›åœ°å€ä¿å­˜äº†å¯¹è±¡ï¼Œä½å›¾ä¸­çš„æ¯ä¸ªå­—èŠ‚éƒ½ä¼šè¡¨ç¤ºå †åŒºä¸­çš„ 32 å­—èŠ‚æ˜¯å¦ç©ºé—²ï¼›
- `arena` åŒºåŸŸæ˜¯çœŸæ­£çš„å †åŒºï¼Œè¿è¡Œæ—¶ä¼šå°† 8KB çœ‹åšä¸€é¡µï¼Œè¿™äº›å†…å­˜é¡µä¸­å­˜å‚¨äº†æ‰€æœ‰åœ¨å †ä¸Šåˆå§‹åŒ–çš„å¯¹è±¡ï¼›

#### ç¨€ç–å†…å­˜ [#](https://draveness.me/golang/docs/part3-runtime/ch07-memory/golang-memory-allocator/#ç¨€ç–å†…å­˜)

ç¨€ç–å†…å­˜æ˜¯ Go è¯­è¨€åœ¨ 1.11 ä¸­æå‡ºçš„æ–¹æ¡ˆï¼Œä½¿ç”¨ç¨€ç–çš„å†…å­˜å¸ƒå±€ä¸ä»…èƒ½ç§»é™¤å †å¤§å°çš„ä¸Šé™[5](https://draveness.me/golang/docs/part3-runtime/ch07-memory/golang-memory-allocator/#fn:5)ï¼Œè¿˜èƒ½è§£å†³ C å’Œ Go æ··åˆä½¿ç”¨æ—¶çš„åœ°å€ç©ºé—´å†²çªé—®é¢˜[6](https://draveness.me/golang/docs/part3-runtime/ch07-memory/golang-memory-allocator/#fn:6)ã€‚ä¸è¿‡å› ä¸ºåŸºäºç¨€ç–å†…å­˜çš„å†…å­˜ç®¡ç†å¤±å»äº†å†…å­˜çš„è¿ç»­æ€§è¿™ä¸€å‡è®¾ï¼Œè¿™ä¹Ÿä½¿å†…å­˜ç®¡ç†å˜å¾—æ›´åŠ å¤æ‚ï¼š

![heap-after-go-1-11](https://img.draveness.me/2020-02-29-15829868066468-heap-after-go-1-11.png)

æ›´è¯¦ç»†å†…å®¹è¯·å‚è€ƒåŸåšå®¢ï¼Œè¿™å—äº†è§£ä¸€ä¸‹å°±è¡Œã€‚



## å†…å­˜ç®¡ç†ç»„ä»¶

Go è¯­è¨€çš„å†…å­˜åˆ†é…å™¨åŒ…å«å†…å­˜ç®¡ç†å•å…ƒã€çº¿ç¨‹ç¼“å­˜ã€ä¸­å¿ƒç¼“å­˜å’Œé¡µå †å‡ ä¸ªé‡è¦ç»„ä»¶ï¼Œæœ¬èŠ‚å°†ä»‹ç»è¿™å‡ ç§æœ€é‡è¦ç»„ä»¶å¯¹åº”çš„æ•°æ®ç»“æ„ [`runtime.mspan`](https://draveness.me/golang/tree/runtime.mspan)ã€[`runtime.mcache`](https://draveness.me/golang/tree/runtime.mcache)ã€[`runtime.mcentral`](https://draveness.me/golang/tree/runtime.mcentral) å’Œ [`runtime.mheap`](https://draveness.me/golang/tree/runtime.mheap)ã€‚

![go-memory-layout](https://img.draveness.me/2020-02-29-15829868066479-go-memory-layout.png)

æ‰€æœ‰çš„ Go è¯­è¨€ç¨‹åºéƒ½ä¼šåœ¨å¯åŠ¨æ—¶åˆå§‹åŒ–å¦‚ä¸Šå›¾æ‰€ç¤ºçš„å†…å­˜å¸ƒå±€ï¼Œæ¯ä¸€ä¸ªå¤„ç†å™¨éƒ½ä¼šåˆ†é…ä¸€ä¸ªçº¿ç¨‹ç¼“å­˜ [`runtime.mcache`](https://draveness.me/golang/tree/runtime.mcache) ç”¨äºå¤„ç†å¾®å¯¹è±¡å’Œå°å¯¹è±¡çš„åˆ†é…ï¼Œå®ƒä»¬ä¼šæŒæœ‰å†…å­˜ç®¡ç†å•å…ƒ [`runtime.mspan`](https://draveness.me/golang/tree/runtime.mspan)ã€‚

æ¯ä¸ªç±»å‹çš„å†…å­˜ç®¡ç†å•å…ƒéƒ½ä¼šç®¡ç†ç‰¹å®šå¤§å°çš„å¯¹è±¡ï¼Œå½“å†…å­˜ç®¡ç†å•å…ƒä¸­ä¸å­˜åœ¨ç©ºé—²å¯¹è±¡æ—¶ï¼Œå®ƒä»¬ä¼šä» [`runtime.mheap`](https://draveness.me/golang/tree/runtime.mheap) æŒæœ‰çš„ 134 ä¸ªä¸­å¿ƒç¼“å­˜ [`runtime.mcentral`](https://draveness.me/golang/tree/runtime.mcentral) ä¸­è·å–æ–°çš„å†…å­˜å•å…ƒï¼Œä¸­å¿ƒç¼“å­˜å±äºå…¨å±€çš„å †ç»“æ„ä½“ [`runtime.mheap`](https://draveness.me/golang/tree/runtime.mheap)ï¼Œå®ƒä¼šä»æ“ä½œç³»ç»Ÿä¸­ç”³è¯·å†…å­˜ã€‚

åœ¨ amd64 çš„ Linux æ“ä½œç³»ç»Ÿä¸Šï¼Œ[`runtime.mheap`](https://draveness.me/golang/tree/runtime.mheap) ä¼šæŒæœ‰ 4,194,304 [`runtime.heapArena`](https://draveness.me/golang/tree/runtime.heapArena)ï¼Œæ¯ä¸ª [`runtime.heapArena`](https://draveness.me/golang/tree/runtime.heapArena) éƒ½ä¼šç®¡ç† 64MB çš„å†…å­˜ï¼Œå•ä¸ª Go è¯­è¨€ç¨‹åºçš„å†…å­˜ä¸Šé™ä¹Ÿå°±æ˜¯ 256TBã€‚

### å†…å­˜ç®¡ç†å•å…ƒ 

```go
type mspan struct {
	next *mspan
	prev *mspan
	...
}
```

![mspan-and-linked-list](https://img.draveness.me/2020-02-29-15829868066485-mspan-and-linked-list.png)

å› ä¸ºç›¸é‚»çš„ç®¡ç†å•å…ƒä¼šäº’ç›¸å¼•ç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä»ä»»æ„ä¸€ä¸ªç»“æ„ä½“è®¿é—®åŒå‘é“¾è¡¨ä¸­çš„å…¶ä»–èŠ‚ç‚¹ã€‚

#### é¡µå’Œå†…å­˜ [#](https://draveness.me/golang/docs/part3-runtime/ch07-memory/golang-memory-allocator/#é¡µå’Œå†…å­˜)

æ¯ä¸ª [`runtime.mspan`](https://draveness.me/golang/tree/runtime.mspan) éƒ½ç®¡ç† `npages` ä¸ªå¤§å°ä¸º 8KB çš„é¡µï¼Œè¿™é‡Œçš„é¡µä¸æ˜¯æ“ä½œç³»ç»Ÿä¸­çš„å†…å­˜é¡µï¼Œå®ƒä»¬æ˜¯æ“ä½œç³»ç»Ÿå†…å­˜é¡µçš„æ•´æ•°å€ã€‚

#### è·¨åº¦ç±» [#](https://draveness.me/golang/docs/part3-runtime/ch07-memory/golang-memory-allocator/#è·¨åº¦ç±»)

[`runtime.spanClass`](https://draveness.me/golang/tree/runtime.spanClass) æ˜¯ [`runtime.mspan`](https://draveness.me/golang/tree/runtime.mspan) çš„è·¨åº¦ç±»ï¼Œå®ƒå†³å®šäº†å†…å­˜ç®¡ç†å•å…ƒä¸­å­˜å‚¨çš„å¯¹è±¡å¤§å°å’Œä¸ªæ•°ï¼š

```go
type mspan struct {
	...
	spanclass   spanClass
	...
}
```

### çº¿ç¨‹ç¼“å­˜ [#](https://draveness.me/golang/docs/part3-runtime/ch07-memory/golang-memory-allocator/#çº¿ç¨‹ç¼“å­˜)

[`runtime.mcache`](https://draveness.me/golang/tree/runtime.mcache) æ˜¯ Go è¯­è¨€ä¸­çš„çº¿ç¨‹ç¼“å­˜ï¼Œå®ƒä¼šä¸çº¿ç¨‹ä¸Šçš„å¤„ç†å™¨ä¸€ä¸€ç»‘å®šï¼Œä¸»è¦ç”¨æ¥ç¼“å­˜ç”¨æˆ·ç¨‹åºç”³è¯·çš„å¾®å°å¯¹è±¡ã€‚æ¯ä¸€ä¸ªçº¿ç¨‹ç¼“å­˜éƒ½æŒæœ‰ 68 * 2 ä¸ª [`runtime.mspan`](https://draveness.me/golang/tree/runtime.mspan)ï¼Œè¿™äº›å†…å­˜ç®¡ç†å•å…ƒéƒ½å­˜å‚¨åœ¨ç»“æ„ä½“çš„ `alloc` å­—æ®µä¸­ï¼š

![mcache-and-mspans](https://img.draveness.me/2020-02-29-15829868066512-mcache-and-mspans.png)

çº¿ç¨‹ç¼“å­˜åœ¨åˆšåˆšè¢«åˆå§‹åŒ–æ—¶æ˜¯ä¸åŒ…å« [`runtime.mspan`](https://draveness.me/golang/tree/runtime.mspan) çš„ï¼Œåªæœ‰å½“ç”¨æˆ·ç¨‹åºç”³è¯·å†…å­˜æ—¶æ‰ä¼šä»ä¸Šä¸€çº§ç»„ä»¶è·å–æ–°çš„ [`runtime.mspan`](https://draveness.me/golang/tree/runtime.mspan) æ»¡è¶³å†…å­˜åˆ†é…çš„éœ€æ±‚ã€‚

### ä¸­å¿ƒç¼“å­˜ [#](https://draveness.me/golang/docs/part3-runtime/ch07-memory/golang-memory-allocator/#ä¸­å¿ƒç¼“å­˜)

[`runtime.mcentral`](https://draveness.me/golang/tree/runtime.mcentral) æ˜¯å†…å­˜åˆ†é…å™¨çš„ä¸­å¿ƒç¼“å­˜ï¼Œä¸çº¿ç¨‹ç¼“å­˜ä¸åŒï¼Œè®¿é—®ä¸­å¿ƒç¼“å­˜ä¸­çš„å†…å­˜ç®¡ç†å•å…ƒéœ€è¦ä½¿ç”¨äº’æ–¥é”ï¼š

```go
type mcentral struct {
	spanclass spanClass
	partial  [2]spanSet
	full     [2]spanSet
}
```

æ¯ä¸ªä¸­å¿ƒç¼“å­˜éƒ½ä¼šç®¡ç†æŸä¸ªè·¨åº¦ç±»çš„å†…å­˜ç®¡ç†å•å…ƒï¼Œå®ƒä¼šåŒæ—¶æŒæœ‰ä¸¤ä¸ª [`runtime.spanSet`](https://draveness.me/golang/tree/runtime.spanSet)ï¼Œåˆ†åˆ«å­˜å‚¨åŒ…å«ç©ºé—²å¯¹è±¡å’Œä¸åŒ…å«ç©ºé—²å¯¹è±¡çš„å†…å­˜ç®¡ç†å•å…ƒã€‚

### é¡µå † [#](https://draveness.me/golang/docs/part3-runtime/ch07-memory/golang-memory-allocator/#é¡µå †)

[`runtime.mheap`](https://draveness.me/golang/tree/runtime.mheap) æ˜¯å†…å­˜åˆ†é…çš„æ ¸å¿ƒç»“æ„ä½“ï¼ŒGo è¯­è¨€ç¨‹åºä¼šå°†å…¶ä½œä¸ºå…¨å±€å˜é‡å­˜å‚¨ï¼Œè€Œå †ä¸Šåˆå§‹åŒ–çš„æ‰€æœ‰å¯¹è±¡éƒ½ç”±è¯¥ç»“æ„ä½“ç»Ÿä¸€ç®¡ç†ï¼Œè¯¥ç»“æ„ä½“ä¸­åŒ…å«ä¸¤ç»„éå¸¸é‡è¦çš„å­—æ®µï¼Œå…¶ä¸­ä¸€ä¸ªæ˜¯å…¨å±€çš„ä¸­å¿ƒç¼“å­˜åˆ—è¡¨ `central`ï¼Œå¦ä¸€ä¸ªæ˜¯ç®¡ç†å †åŒºå†…å­˜åŒºåŸŸçš„ `arenas` ä»¥åŠç›¸å…³å­—æ®µã€‚

é¡µå †ä¸­åŒ…å«ä¸€ä¸ªé•¿åº¦ä¸º 136 çš„ [`runtime.mcentral`](https://draveness.me/golang/tree/runtime.mcentral) æ•°ç»„ï¼Œå…¶ä¸­ 68 ä¸ªä¸ºè·¨åº¦ç±»éœ€è¦ `scan` çš„ä¸­å¿ƒç¼“å­˜ï¼Œå¦å¤–çš„ 68 ä¸ªæ˜¯ `noscan` çš„ä¸­å¿ƒç¼“å­˜ï¼š

![mheap-and-mcentrals](https://img.draveness.me/2020-02-29-15829868066525-mheap-and-mcentrals.png)

æ›´å¤šæºç çº§çš„è®²è§£è¯·çœ‹åŸåšå®¢ã€‚



ä¸‹é¢è¡¥å……ä¹¦ç±é‡Œçš„å†…å®¹ï¼Œè¿˜æ˜¯æŒ‰ä¹¦ç±ç« èŠ‚æ¥ï¼Œç”±äºä¹¦ç±ä¸­çš„ go ç‰ˆæœ¬æ˜¯ 1.6ï¼Œä»…ä¾›å‚è€ƒã€‚

## 16.1 æ¦‚è¿°

åŸºæœ¬ç­–ç•¥ï¼š

1. æ¯æ¬¡ä»æ“ä½œç³»ç»Ÿç”³è¯·ä¸€å¤§å—å†…å­˜ï¼ˆæ¯”å¦‚ 1MBï¼‰ï¼Œä»¥å‡å°‘ç³»ç»Ÿè°ƒç”¨ã€‚
2. å°†ç”³è¯·åˆ°çš„å¤§å—å†…å­˜æŒ‰ç…§ç‰¹å®šå¤§å°é¢„å…ˆåˆ‡åˆ†æˆå°å—ï¼Œæ„æˆé“¾è¡¨ã€‚
3. ä¸ºå¯¹è±¡åˆ†é…å†…å­˜æ—¶ï¼Œåªéœ€ä»å¤§å°åˆé€‚çš„é“¾è¡¨æå–ä¸€ä¸ªå°å—å³å¯ã€‚
4. å›æ”¶å¯¹è±¡å†…å­˜æ—¶ï¼Œå°†è¯¥å°å—å†…å­˜é‡æ–°å½’è¿˜åˆ°åŸé“¾è¡¨ï¼Œä»¥ä¾¿å¤ç”¨ã€‚
5. å¦‚é—²ç½®å†…å­˜è¿‡å¤šï¼Œåˆ™å°è¯•å½’è¿˜éƒ¨åˆ†å†…å­˜ç»™æ“ä½œç³»ç»Ÿï¼Œé™ä½æ•´ä½“å¼€é”€ã€‚

Golangå†…å­˜åˆ†é…ç®¡ç†ç­–ç•¥æ˜¯**æŒ‰ç…§ä¸åŒå¤§å°çš„å¯¹è±¡å’Œä¸åŒçš„å†…å­˜å±‚çº§æ¥åˆ†é…ç®¡ç†å†…å­˜**ã€‚é€šè¿‡è¿™ç§å¤šå±‚çº§åˆ†é…ç­–ç•¥ï¼Œå½¢æˆæ— é”åŒ–æˆ–è€…é™ä½é”çš„ç²’åº¦ï¼Œä»¥åŠå°½é‡å‡å°‘å†…å­˜ç¢ç‰‡ï¼Œæ¥æé«˜å†…å­˜åˆ†é…æ•ˆç‡ã€‚

Goçš„å†…å­˜åˆ†é…å™¨åœ¨åˆ†é…å¯¹è±¡æ—¶ï¼Œæ ¹æ®å¯¹è±¡çš„å¤§å°ï¼Œåˆ†æˆä¸‰ç±»ï¼šå°å¯¹è±¡ï¼ˆå°äºç­‰äº16Bï¼‰ã€ä¸€èˆ¬å¯¹è±¡ï¼ˆå¤§äº16Bï¼Œå°äºç­‰äº32KBï¼‰ã€å¤§å¯¹è±¡ï¼ˆå¤§äº32KBï¼‰ã€‚

å¤§ä½“ä¸Šçš„åˆ†é…æµç¨‹ï¼š

- 32KB çš„å¯¹è±¡ï¼Œç›´æ¥ä»mheapä¸Šåˆ†é…ï¼›
- <=16B çš„å¯¹è±¡ä½¿ç”¨mcacheçš„tinyåˆ†é…å™¨åˆ†é…ï¼›
- (16B,32KB] çš„å¯¹è±¡ï¼Œé¦–å…ˆè®¡ç®—å¯¹è±¡çš„è§„æ ¼å¤§å°ï¼Œç„¶åä½¿ç”¨mcacheä¸­ç›¸åº”è§„æ ¼å¤§å°çš„mspanåˆ†é…ï¼›
- å¦‚æœmcacheæ²¡æœ‰ç›¸åº”è§„æ ¼å¤§å°çš„mspanï¼Œåˆ™å‘mcentralç”³è¯·
- å¦‚æœmcentralæ²¡æœ‰ç›¸åº”è§„æ ¼å¤§å°çš„mspanï¼Œåˆ™å‘mheapç”³è¯·
- å¦‚æœmheapä¸­ä¹Ÿæ²¡æœ‰åˆé€‚å¤§å°çš„mspanï¼Œåˆ™å‘æ“ä½œç³»ç»Ÿç”³è¯·

![img](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5ebaa346a60947a6a570abaef9719ace~tplv-k3u1fbpfcp-watermark.awebp)

### å†…å­˜å—

åˆ†é…å™¨å°†å…¶ç®¡ç†çš„å†…å­˜å—åˆ†ä¸ºä¸¤ç§ã€‚

- spanï¼šç”±å¤šä¸ªåœ°å€è¿ç»­çš„é¡µç»„æˆçš„å¤§å—å†…å­˜ã€‚
- objectï¼šå°† span æŒ‰ç‰¹å®šå¤§å°åˆ‡åˆ†æˆå¤šä¸ªå°å—ï¼Œæ¯ä¸ªå°å—å¯å­˜å‚¨ä¸€ä¸ªå¯¹è±¡ã€‚

> æŒ‰ç…§å…¶ç”¨é€”ï¼Œspan é¢å‘å†…éƒ¨ç®¡ç†ï¼Œ object é¢å‘å¯¹è±¡åˆ†é…ã€‚

å°å¯¹è±¡åˆ†é…ä¼šåœ¨ span page ä¸­åˆ’åˆ†æ›´å°çš„ç²’åº¦ï¼›å¤§å¯¹è±¡é€šè¿‡å¤šé¡µå®ç°ã€‚

### ç®¡ç†ç»„ä»¶

Go é‡‡ç”¨äº† tcmalloc çš„æˆç†Ÿæ¶æ„ã€‚

åˆ†é…å™¨ç”±ä¸‰ç§ç»„ä»¶ç»„æˆï¼š

- cacheï¼šæ¯ä¸ªè¿è¡ŒæœŸå·¥ä½œçº¿ç¨‹éƒ½ä¼šç»‘å®šä¸€ä¸ª cacheï¼Œç”¨äºæ— é” object åˆ†é…ã€‚
- centralï¼šcache ä¸­æ²¡æœ‰å¯ç”¨çš„ span æ—¶å€™ï¼Œä¼šå‘ central ç”³è¯·ã€‚
- heapï¼šç®¡ç†é—²ç½® spanï¼Œéœ€è¦æ—¶å‘æ“ä½œç³»ç»Ÿç”³è¯·æ–°å†…å­˜ã€‚

å…·ä½“ä»£ç å¯ä»¥æŸ¥çœ‹ [`runtime.mspan`](https://draveness.me/golang/tree/runtime.mspan)ã€[`runtime.mcache`](https://draveness.me/golang/tree/runtime.mcache)ã€[`runtime.mcentral`](https://draveness.me/golang/tree/runtime.mcentral) å’Œ [`runtime.mheap`](https://draveness.me/golang/tree/runtime.mheap)ã€‚



## 16.3 åˆ†é…

